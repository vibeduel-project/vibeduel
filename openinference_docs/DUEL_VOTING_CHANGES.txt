Duel Voting System - Frontend Changes Summary
================================================

Overview:
Built an end-to-end duel/voting system in the OpenCode TUI where two LLM models
compete head-to-head in a split-pane view. Users submit a prompt, both models
generate responses simultaneously, the user votes for the better response via
mouse click, and the vote is submitted to the vLLM proxy backend for ELO tracking.
After voting, the winning model's history is forked so both panes share it, and
the next prompt is sent to both.

Files Modified:
---------------

1. packages/opencode/src/cli/cmd/tui/routes/session/index.tsx
   - Added duel logging via Log.create({ service: "duel" })
   - awaitingVote initialized to isSplit() (not false) so first round from
     home.tsx correctly shows vote buttons
   - Added bothDone gating: leftDone, rightDone, bothDone memos that check
     lastAssistant?.time.completed for each side before enabling vote buttons
   - promptDisabled changed to: isSplit() && awaitingVote() && bothDone()
   - Removed arrow key voting (left/right keys) — mouse click only
   - Changed hint text from "select side (←/→)" to "click to vote"
   - finalizeVote now POSTs to backend /v1/duel/vote endpoint with
     {duel_session_id, winner: "a"|"b"}, using process.env for config
   - Vote response includes model names; stored in modelReveal signal
   - Model reveal UI shown between vote and next message submission
   - Deferred fork: finalizeVote stores pendingForkWinner instead of
     forking immediately
   - onSubmit handles fork when pendingForkWinner is set:
     * Forks the winning session
     * Sends prompt to both winner and fork
     * Navigates so fork replaces the losing pane
   - skipAutoSend prop passed to Prompt when pendingForkWinner is set
   - Comprehensive logging at every state transition: session mount,
     vote-button visibility, finalizeVote, enterDuel, exitDuel, onSubmit,
     vote clicks, assistant message completion, pane state changes

2. packages/opencode/src/cli/cmd/tui/routes/session/permission.tsx
   - Replaced file-based logToSide with duelLog = Log.create({ service: "duel" })
   - Removed appendFile import

3. packages/opencode/src/cli/cmd/tui/context/route.tsx
   - Added duelSessionId?: string to SessionRoute type
   - Added duelSessionId to setStore() in navigate()

4. packages/opencode/src/cli/cmd/tui/routes/home.tsx
   - Passes duelSessionId through navigate() when entering split view

5. packages/opencode/src/cli/cmd/tui/component/prompt/index.tsx
   - Added skipAutoSend?: boolean prop
   - When skipAutoSend is true, Prompt does NOT auto-send messages
     (defers to onSubmit handler)
   - Added duel logging for send/broadcast/skip/onSubmit events

Key Design Decisions:
---------------------

- Duel session ID is generated client-side and passed through route params
  (not from server-side duel.ts Map, which lives in a separate process)
- Backend env vars accessed via process.env (not Env.get() which requires
  Instance context unavailable in TUI process)
- Fork happens on NEXT message submission, not immediately on vote, so the
  user sees model reveal before continuing
- skipAutoSend pattern solves timing issue where Prompt normally sends
  messages before calling onSubmit — without it, the fork would happen
  too late and forked session wouldn't get the new prompt
- All logging uses Log.create({ service: "duel" }) writing to
  /home/mark/.local/share/opencode/log/dev-tui.log

Duel Flow (per round):
-----------------------
1. User enters prompt in split-pane view
2. Prompt generates duel_session_id, sends to both sessions with model="duel"
3. Backend assigns side "a" (first arrival) and "b" (second)
4. Both models generate responses simultaneously
5. When both complete (bothDone), vote buttons appear
6. User clicks to vote for left or right
7. Vote POSTed to /v1/duel/vote → backend updates ELO ratings
8. Model names revealed from vote response
9. User enters next prompt
10. Winner session forked, prompt sent to both winner + fork
11. Navigate: fork replaces losing pane
12. Repeat from step 3

Known Issues:
-------------
- Agent freeze: On round 3, right agent froze during tool use (bash
  permission). Left session ID changed unexpectedly, likely related to
  permission system session forking during tool use.

Potentially Fixed Issues - monitoring:
- Double-vote bug: onMouseUp fires twice on vote button click, submitting
  the vote twice to the backend and double-counting ELO. Needs a guard
  in finalizeVote to prevent re-entry.

CRITICAL FOR DEBUGGING - LOG FILE PATHS:
- /home/mark/.local/share/opencode/log/dev.log
- /home/mark/.local/share/opencode/log/dev-tui.log