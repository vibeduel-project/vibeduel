#!/usr/bin/env bash
set -euo pipefail
APP=opencode

MUTED='\033[0;2m'
RED='\033[0;31m'
ORANGE='\033[38;5;214m'
NC='\033[0m' # No Color

usage() {
    cat <<EOF
VibeDuel Installer

Usage: install.sh [options]

Options:
    -h, --help              Display this help message
    -v, --version <version> Install a specific version (e.g., 1.0.180)
        --no-modify-path    Don't modify shell config files (.zshrc, .bashrc, etc.)

Examples:
    curl -fsSL https://vibeduel.ai/install | bash
    curl -fsSL https://vibeduel.ai/install | bash -s -- --version 1.0.180
EOF
}

requested_version=${VERSION:-}
no_modify_path=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            if [[ -n "${2:-}" ]]; then
                requested_version="$2"
                shift 2
            else
                echo -e "${RED}Error: --version requires a version argument${NC}"
                exit 1
            fi
            ;;
        --no-modify-path)
            no_modify_path=true
            shift
            ;;
        *)
            echo -e "${ORANGE}Warning: Unknown option '$1'${NC}" >&2
            shift
            ;;
    esac
done

raw_os=$(uname -s)
os=$(echo "$raw_os" | tr '[:upper:]' '[:lower:]')
case "$raw_os" in
  Darwin*) os="darwin" ;;
  Linux*) os="linux" ;;
  MINGW*|MSYS*|CYGWIN*) os="windows" ;;
esac

arch=$(uname -m)
if [[ "$arch" == "aarch64" ]]; then
  arch="arm64"
fi
if [[ "$arch" == "x86_64" ]]; then
  arch="x64"
fi

if [ "$os" = "darwin" ] && [ "$arch" = "x64" ]; then
  rosetta_flag=$(sysctl -n sysctl.proc_translated 2>/dev/null || echo 0)
  if [ "$rosetta_flag" = "1" ]; then
    arch="arm64"
  fi
fi

combo="$os-$arch"
case "$combo" in
  linux-x64|linux-arm64|darwin-x64|darwin-arm64|windows-x64)
    ;;
  *)
    echo -e "${RED}Unsupported OS/Arch: $os/$arch${NC}"
    exit 1
    ;;
esac

archive_ext=".zip"
if [ "$os" = "linux" ]; then
  archive_ext=".tar.gz"
fi

is_musl=false
if [ "$os" = "linux" ]; then
  if [ -f /etc/alpine-release ]; then
    is_musl=true
  fi

  if command -v ldd >/dev/null 2>&1; then
    if ldd --version 2>&1 | grep -qi musl; then
      is_musl=true
    fi
  fi
fi

needs_baseline=false
if [ "$arch" = "x64" ]; then
  if [ "$os" = "linux" ]; then
    if ! grep -qi avx2 /proc/cpuinfo 2>/dev/null; then
      needs_baseline=true
    fi
  fi

  if [ "$os" = "darwin" ]; then
    avx2=$(sysctl -n hw.optional.avx2_0 2>/dev/null || echo 0)
    if [ "$avx2" != "1" ]; then
      needs_baseline=true
    fi
  fi
fi

target="$os-$arch"
if [ "$needs_baseline" = "true" ]; then
  target="$target-baseline"
fi
if [ "$is_musl" = "true" ]; then
  target="$target-musl"
fi

filename="$APP-$target$archive_ext"


if [ "$os" = "linux" ]; then
    if ! command -v tar >/dev/null 2>&1; then
         echo -e "${RED}Error: 'tar' is required but not installed.${NC}"
         exit 1
    fi
else
    if ! command -v unzip >/dev/null 2>&1; then
        echo -e "${RED}Error: 'unzip' is required but not installed.${NC}"
        exit 1
    fi
fi

INSTALL_DIR=$HOME/.local/bin
mkdir -p "$INSTALL_DIR"

if [ -z "$requested_version" ]; then
    url="https://github.com/vibeduel-project/vibeduel/releases/latest/download/$filename"
    specific_version=$(curl -s https://api.github.com/repos/vibeduel-project/vibeduel/releases/latest | sed -n 's/.*"tag_name": *"v\([^"]*\)".*/\1/p')

    if [[ $? -ne 0 || -z "$specific_version" ]]; then
        echo -e "${RED}Failed to fetch version information${NC}"
        exit 1
    fi
else
    # Strip leading 'v' if present
    requested_version="${requested_version#v}"
    url="https://github.com/vibeduel-project/vibeduel/releases/download/v${requested_version}/$filename"
    specific_version=$requested_version
    
    # Verify the release exists before downloading
    http_status=$(curl -sI -o /dev/null -w "%{http_code}" "https://github.com/vibeduel-project/vibeduel/releases/tag/v${requested_version}")
    if [ "$http_status" = "404" ]; then
        echo -e "${RED}Error: Release v${requested_version} not found${NC}"
        echo -e "${MUTED}Available releases: https://github.com/vibeduel-project/vibeduel/releases${NC}"
        exit 1
    fi
fi

print_message() {
    local level=$1
    local message=$2
    local color=""

    case $level in
        info) color="${NC}" ;;
        warning) color="${NC}" ;;
        error) color="${RED}" ;;
    esac

    echo -e "${color}${message}${NC}"
}

migrate_from_old_location() {
    local old_install_dir="$HOME/.vibeduel/bin"
    
    [[ ! -f "$old_install_dir/vibeduel" ]] && return
    
    print_message info "${MUTED}Migrating from ${NC}$old_install_dir${MUTED} to ${NC}$INSTALL_DIR"
    
    # Remove old binary
    rm -f "$old_install_dir/vibeduel"
    rmdir "$old_install_dir" 2>/dev/null || true
    rmdir "$HOME/.vibeduel" 2>/dev/null || true
    
    # Clean up old PATH entries from shell configs
    for config_file in "$HOME/.bashrc" "$HOME/.zshrc" "$HOME/.config/fish/config.fish"; do
        if [[ -f "$config_file" ]]; then
            sed -i.bak "/\.vibeduel\/bin/d" "$config_file"
            rm -f "${config_file}.bak"
        fi
    done
    
    print_message info "${MUTED}Cleaned up old installation${NC}"
}

check_version() {
    [[ ! -f "$INSTALL_DIR/vibeduel" ]] && return
    
    installed_version=$("$INSTALL_DIR/vibeduel" --version 2>/dev/null) || {
        print_message warning "${MUTED}Could not determine installed version, reinstalling${NC}"
        return
    }
    
    # Compare timestamps (YYYYMMDDHHMM format)
    installed_ts="${installed_version##*-}"
    requested_ts="${specific_version##*-}"
    
    if [[ "$installed_ts" -ge "$requested_ts" ]]; then
        print_message info "${MUTED}Version ${NC}$installed_version${MUTED} already installed${NC}"
        exit 0
    fi
    
    print_message info "${MUTED}Installed: ${NC}$installed_version${MUTED}, upgrading to ${NC}$specific_version"
}

unbuffered_sed() {
    local pad
    if echo | sed -u -e "" >/dev/null 2>&1; then
        sed -nu "$@"
    elif echo | sed -l -e "" >/dev/null 2>&1; then
        sed -nl "$@"
    else
        pad="$(printf "\n%512s" "")"
        sed -ne "s/$/\\${pad}/" "$@"
    fi
}

print_progress() {
    local bytes="$1"
    local length="$2"
    [ "$length" -gt 0 ] || return 0

    local width=50 percent on off filled empty
    percent=$(( bytes * 100 / length ))
    [ "$percent" -gt 100 ] && percent=100
    on=$(( percent * width / 100 ))
    off=$(( width - on ))

    filled=$(printf "%*s" "$on" "")
    filled=${filled// /■}
    empty=$(printf "%*s" "$off" "")
    empty=${empty// /･}

    printf "\r${ORANGE}%s%s %3d%%${NC}" "$filled" "$empty" "$percent" >&4
}

download_with_progress() {
    local url="$1"
    local output="$2"

    if [ -t 2 ]; then
        exec 4>&2
    else
        exec 4>/dev/null
    fi

    local tmp_dir=${TMPDIR:-/tmp}
    local basename="${tmp_dir}/opencode_install_$$"
    local tracefile="${basename}.trace"

    rm -f "$tracefile"
    mkfifo "$tracefile"

    # Hide cursor
    printf "\033[?25l" >&4

    trap 'trap - RETURN; rm -f "$tracefile"; printf "\033[?25h" >&4; exec 4>&-' RETURN

    (
        curl --trace-ascii "$tracefile" -s -L -o "$output" "$url"
    ) &
    local curl_pid=$!

    unbuffered_sed \
        -e 'y/ACDEGHLNORTV/acdeghlnortv/' \
        -e '/^0000: content-length:/p' \
        -e '/^<= recv data/p' \
        "$tracefile" | \
    {
        local length=0
        local bytes=0
        
        while IFS=" " read -r -a line; do
            [ "${#line[@]}" -lt 2 ] && continue
            local tag="${line[0]} ${line[1]}"
            
            if [ "$tag" = "0000: content-length:" ]; then
                length="${line[2]}"
                length=$(echo "$length" | tr -d '\r')
                bytes=0
            elif [ "$tag" = "<= recv" ]; then
                local size="${line[3]}"
                bytes=$(( bytes + size ))
                if [ "$length" -gt 0 ]; then
                    print_progress "$bytes" "$length"
                fi
            fi
        done
    }

    wait $curl_pid
    local ret=$?
    echo "" >&4
    return $ret
}

download_and_install() {
    print_message info "\n${MUTED}Installing ${NC}vibeduel ${MUTED}version: ${NC}$specific_version"
    local tmp_dir="${TMPDIR:-/tmp}/vibeduel_install_$$"
    mkdir -p "$tmp_dir" || {
        print_message error "Failed to create temporary directory: $tmp_dir"
        exit 1
    }
    
    trap 'rm -rf "$tmp_dir"' EXIT
    
    # Download with progress or fallback
    if [[ "$os" == "windows" ]] || ! [ -t 2 ] || ! download_with_progress "$url" "$tmp_dir/$filename"; then
        curl -# -L -o "$tmp_dir/$filename" "$url" || {
            print_message error "Failed to download from $url"
            exit 1
        }
    fi

    # Validate download
    if [[ ! -f "$tmp_dir/$filename" ]]; then
        print_message error "Download failed: $filename not found"
        exit 1
    fi

    # Extract
    if [ "$os" = "linux" ]; then
        tar -xzf "$tmp_dir/$filename" -C "$tmp_dir" || {
            print_message error "Failed to extract $filename"
            exit 1
        }
    else
        unzip -q "$tmp_dir/$filename" -d "$tmp_dir" || {
            print_message error "Failed to extract $filename"
            exit 1
        }
    fi
    
    # Validate binary was extracted
    if [[ ! -f "$tmp_dir/opencode" ]]; then
        print_message error "Binary not found in archive (expected: $tmp_dir/opencode)"
        exit 1
    fi

    # Install with validation
    mv "$tmp_dir/opencode" "$INSTALL_DIR/vibeduel" || {
        print_message error "Failed to move binary to $INSTALL_DIR"
        exit 1
    }
    
    chmod 755 "${INSTALL_DIR}/vibeduel" || {
        print_message error "Failed to set executable permissions"
        exit 1
    }
    
    # Final validation
    if ! [[ -x "$INSTALL_DIR/vibeduel" ]]; then
        print_message error "Installation validation failed: binary not executable"
        exit 1
    fi
}

migrate_from_old_location
check_version
download_and_install


add_to_path() {
    local config_file=$1
    local command=$2

    if grep -Fxq "$command" "$config_file"; then
        print_message info "Command already exists in $config_file, skipping write."
    elif [[ -w $config_file ]]; then
        echo -e "\n# vibeduel" >> "$config_file"
        echo "$command" >> "$config_file"
        print_message info "${MUTED}Successfully added ${NC}vibeduel ${MUTED}to \$PATH in ${NC}$config_file"
    else
        print_message warning "Manually add the directory to $config_file (or similar):"
        print_message info "  $command"
    fi
}

if [[ "$no_modify_path" != "true" ]]; then
    if [[ ":$PATH:" == *":$INSTALL_DIR:"* ]]; then
        print_message info "${MUTED}$INSTALL_DIR already in \$PATH${NC}"
    else
        modified_files=()
        
        # Check and add to bashrc (prioritize over bash_profile)
        if [[ -f "$HOME/.bashrc" ]]; then
            add_to_path "$HOME/.bashrc" "export PATH=$INSTALL_DIR:\$PATH"
            modified_files+=("$HOME/.bashrc")
        fi
        
        # Check and add to zshrc
        if [[ -f "$HOME/.zshrc" ]]; then
            add_to_path "$HOME/.zshrc" "export PATH=$INSTALL_DIR:\$PATH"
            modified_files+=("$HOME/.zshrc")
        fi
        
        # Check and add to fish config
        if [[ -f "$HOME/.config/fish/config.fish" ]]; then
            add_to_path "$HOME/.config/fish/config.fish" "fish_add_path $INSTALL_DIR"
            modified_files+=("$HOME/.config/fish/config.fish")
        fi
        
        # Reload shell configuration for current session
        if [[ ${#modified_files[@]} -gt 0 ]]; then
            current_shell=$(basename "$SHELL")
            case $current_shell in
                bash)
                    [[ -f "$HOME/.bashrc" ]] && source "$HOME/.bashrc"
                    ;;
                zsh)
                    [[ -f "$HOME/.zshrc" ]] && source "$HOME/.zshrc"
                    ;;
                fish)
                    [[ -f "$HOME/.config/fish/config.fish" ]] && source "$HOME/.config/fish/config.fish"
                    ;;
            esac
        fi
    fi
fi

if [ -n "${GITHUB_ACTIONS-}" ] && [ "${GITHUB_ACTIONS}" == "true" ]; then
    echo "$INSTALL_DIR" >> "$GITHUB_PATH"
    print_message info "Added $INSTALL_DIR to \$GITHUB_PATH"
fi

echo -e ""
echo -e "${MUTED}                    ${NC}             ▄     "
echo -e "${MUTED}█▀▀█ █▀▀█ █▀▀█ █▀▀▄ ${NC}█▀▀▀ █▀▀█ █▀▀█ █▀▀█"
echo -e "${MUTED}█░░█ █░░█ █▀▀▀ █░░█ ${NC}█░░░ █░░█ █░░█ █▀▀▀"
echo -e "${MUTED}▀▀▀▀ █▀▀▀ ▀▀▀▀ ▀  ▀ ${NC}▀▀▀▀ ▀▀▀▀ ▀▀▀▀ ▀▀▀▀"
echo -e ""
echo -e ""
echo -e "${MUTED}Free AI coding assistant. To start:${NC}"
echo -e ""
echo -e "cd <project>  ${MUTED}# Open directory${NC}"
echo -e "vibeduel      ${MUTED}# Run command${NC}"
echo -e ""
echo -e "${MUTED}For more information visit ${NC}https://vibeduel.ai"
echo -e ""
echo -e ""

